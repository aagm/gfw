function CartoDBInfowindow(map, opts) {

  this.content = {};

  this.latlng_ = null;
  this.offsetHorizontal_ = 0;
  this.offsetVertical_   = -10;
  this.width_ = 255;
  this.div_ = null;
  this.map_ = map;
  this.setMap(map);

  if (opts) {
    this.className         = opts.className;
    this.offsetHorizontal_ = ("offsetHorizontal" in opts) ? opts.offsetHorizontal : 0;
    this.offsetVertical_   = ("offsetVertical" in opts) ? opts.offsetVertical : 0;
    this.width_            = opts.width;
    this.template          = opts.template;
  }
}


CartoDBInfowindow.prototype = new google.maps.OverlayView();


CartoDBInfowindow.prototype.draw = function() {
  var me = this,
      div = this.div_;

  if (!div) {
    div = this.div_ = document.createElement('DIV');

    div.className = this.className || "cartodb_infowindow";

    this.template_image = '<a href="#close" class="close"></a>'+
      '<div class="outer_top">'+
      '<div class="top">'+
      '<div class="protected-header">'+
      '<h1></h1><a href="#" class="analyse"></a><div class="cover imgLiquidFill" style="width:295px; height:120px;"><img src="<%= image_path('backgrounds/cover.png') %>" /></div>'+
      '</div>'+
      '<div class="infowindow_content"></div>'+
      '</div>'+
      '</div>'+
      '<div class="shadow"></div>'+
      '<div class="bottom"></div>';

    this.template_base = '<a href="#close" class="close"></a>'+
      '<div class="outer_top">'+
      '<div class="top">'+
      '<div class="protected-header template_base"><a href="#" class="analyse"></div>' +
      '<div class="infowindow_content"></div>'+
      '</div>'+
      '</div>'+
      '<div class="shadow"></div>'+
      '<div class="bottom"></div>';

    div.innerHTML = this.template_image || this.template_base;

    var a = this.getElementsByClassName("close", div)[0];

    google.maps.event.addDomListener(a, 'click', function (ev) {
      //ev.preventDefault ? ev.preventDefault() : ev.returnValue = false;
      //me._hide();
    });

    google.maps.event.addDomListener(div, 'click', function (ev) {
      //ev.preventDefault ? ev.preventDefault() : ev.returnValue = false;
      //ev.stopPropagation ? ev.stopPropagation() : window.event.cancelBubble = true;
    });

    google.maps.event.addDomListener(a, 'touchend', function (ev) {
      ev.preventDefault ? ev.preventDefault() : ev.returnValue = false;
      //me._hide();
    });

    google.maps.event.addDomListener(div, 'touchstart', function (ev) {
      ev.preventDefault ? ev.preventDefault() : ev.returnValue = false;
    });

    google.maps.event.addDomListener(div, 'touchend', function (ev) {
      ev.preventDefault ? ev.preventDefault() : ev.returnValue = false;
    });

    google.maps.event.addDomListener(div, 'dblclick', function (ev) {
      ev.preventDefault ? ev.preventDefault() : ev.returnValue = false;
    });
    google.maps.event.addDomListener(div, 'mousedown', function (ev) {
      ev.preventDefault ? ev.preventDefault() : ev.returnValue = false;
      ev.stopPropagation ? ev.stopPropagation() : window.event.cancelBubble = true;
    });
    google.maps.event.addDomListener(div, 'mouseup', function (ev) {
      ev.preventDefault ? ev.preventDefault() : ev.returnValue = false;
    });
    google.maps.event.addDomListener(div, 'mousewheel', function (ev) {
      ev.stopPropagation ? ev.stopPropagation() : window.event.cancelBubble = true;
    });
    google.maps.event.addDomListener(div, 'DOMMouseScroll', function (ev) {
      ev.stopPropagation ? ev.stopPropagation() : window.event.cancelBubble = true;
    });

    var panes = this.getPanes();
    panes.floatPane.appendChild(div);

    div.style.opacity = 0;
  }

  this.setPosition();
};


CartoDBInfowindow.prototype.setVisibleColumns = function(columns){
  this.visible_columns = columns;
},


CartoDBInfowindow.prototype.setMode = function(mode){
  this.mode = mode;

  if (this.mode == "image") {
    this.template = this.template_image;
    this.div_.innerHTML = this.template;
    this.div_.className = "cartodb_infowindow with_image_small with_image_2";
  } else {
    this.template = this.template_base;
    this.div_.innerHTML = this.template;
    this.div_.className = "cartodb_infowindow";
  }
};


CartoDBInfowindow.prototype.setTemplate = function(template){
  this.template_ = template;
};


CartoDBInfowindow.prototype.setOffset = function(offsetVertical, offsetHorizontal){
  this.offsetHorizontal_ = offsetHorizontal;
  this.offsetVertical_   = offsetVertical;
};


CartoDBInfowindow.prototype.setContent = function(content){
  if (this.div_) {
    this.content = content;
    var div = this.div_,
        top = this.getElementsByClassName("infowindow_content", div)[0];

    if (!content) { return; }

    if (typeof content === 'string') {
      top.innerHTML = content;
    } else {
      top.innerHTML = '';
      var html = '';

      function show_column(column, content, visible_columns) {
        if (!visible_columns) {
          return column != "slug" && content[column] != null && content[column] != '';
        } else {
          return column != "slug" && content[column] != null && content[column] != '' && _.contains(visible_columns, column);
        }
      }

      for(var column in content) {
        if (!(column == 'The geom' ||Â column == 'Cartodb id')) {        
          if (show_column(column, content, this.visible_columns)) {
            var column_ = column,
                suffix  = '';

            switch(column){
              case 'photo_credit':
                column_ = 'Photo credit';
                break;
              case 'Brightness':
                suffix = ' (Kelvin)';
                break;
              case 'Confidence':
                suffix = ' (%)';
                break;
              case 'Acq time':
                column_ = 'Acquisition time';
                suffix   = ' (UTC)';
                break;
              case 'Acq date':
                column_ = 'Acquisition date';
                break;
            }

            html += '<label>' + column_ + '</label>';
            html += '<p class="'+((content[column]!=null && content[column]!='')?'':'empty')+'">'+(content[column] || 'empty')+ suffix + '</p>';
          }
        }
      }

      top.innerHTML = html;

      if (this.mode == "image") {
        $(div).find("h1").html(content.name);
        $(div).find("img").attr("src", content.image.replace("square", "medium"));
        $(div).find("img").css("width", "295px");
      }
    }
  }
};


CartoDBInfowindow.prototype.setPosition = function(latlng) {
  if (latlng) {
    this.latlng_ = latlng;
    // Adjust pan
    this._adjustPan();
  }
  
  if (this.div_) {
    var div = this.div_,
    olatlng = this.latlng_ ? new google.maps.LatLng(this.latlng_[0], this.latlng_[1]) : this.latlng_,
    pixPosition = this.getProjection().fromLatLngToDivPixel(olatlng);
    if (pixPosition) {
      div.style.width = this.width_ + 'px';
      div.style.left = (pixPosition.x - this.width_ / 2 + this.offsetHorizontal_) + 'px';
      var actual_height = - div.clientHeight;
      div.style.top = (pixPosition.y + actual_height + this.offsetVertical_) + 'px';
    }
  }
};


CartoDBInfowindow.prototype.open = function(){
  this._show();
};

CartoDBInfowindow.prototype._createScroll = function() {
  var pane = $(".cartodb_infowindow").find(".top").jScrollPane(),
      api = pane.data('jsp');
  api.scrollToY(0); // scroll to top
};

CartoDBInfowindow.prototype.close = function(){
  this._hide();
};


CartoDBInfowindow.prototype.destroy = function() {
  // Check if the overlay was on the map and needs to be removed.
  if (this.div_) {
    this.div_.parentNode.removeChild(this.div_);
    this.div_ = null;
  }

  this.setMap(null);
};


CartoDBInfowindow.prototype._hide = function() {
  if (this.div_) {
    var div = this.div_;

    $(div).animate({
      opacity: 0,
      duration: 1
    });

    $(div).hide();
  }
};


CartoDBInfowindow.prototype._show = function() {
  if (this.div_) {
    var div  = this.div_,
        that = this;
    div.style.opacity = 0;

    var offset = 0;

    if ($(div).hasClass('story_infowindow') && !$(div).is(':visible')) {
      offset = 80;
    }

    if (!$(div).hasClass('story_infowindow')) {
      offset = 225;
    }

    div.style.top = (parseInt(div.style.top, 10) - 10 - offset) + 'px';

    if (this.mode === "image") {
      $(".imgLiquidFill").imgLiquid();
    }

    $(div).show(function() {
      $(div).animate({
        opacity: 1,
        duration: 250
      }, function(){
        that._createScroll()
      });
    });
    var me = this;
    $('#map').find('.protected-header .analyse').on('click', function(ev){
      ev.preventDefault ? ev.preventDefault() : ev.returnValue = false;
      Analysis._loadUseConservationAreas( $.parseJSON(me.content.the_geom) ? $.parseJSON(me.content.the_geom) : $.parseJSON(me.content['The geom']),
                                          me.content.cartodb_id ? me.content.cartodb_id : me.content['Cartodb id'],
                                          me.content.name ? me.content.name : me.content.Name,
                                          me.content.table ? me.content.table : me.content.Table
                                        );
      me._hide();
    })
  }
};


CartoDBInfowindow.prototype._adjustPan = function() {
  //debugger;
  var left = 0,
      top = 0,
      latlng = new google.maps.LatLng(this.latlng_[0], this.latlng_[1]),
      pixPosition = this.getProjection().fromLatLngToContainerPixel(latlng),
      container = this.map_.getDiv(),
      div_height = this.div_.clientHeight;

  if ((pixPosition.x - 65) < 0) {
    left = (pixPosition.x - 65);
  }

  if ((pixPosition.x + 180) >= container.clientWidth) {
    left = (pixPosition.x + 180 - container.clientWidth);
  }

  if ((pixPosition.y - div_height) < 0) {
    top = (pixPosition.y - div_height - 20);
  }

  this.map_.panBy(left,top);
};


CartoDBInfowindow.prototype.getElementsByClassName = function(classname, node)  {
  if(!node) node = document.getElementsByTagName("body")[0];

  var a = [],
      re = new RegExp('\\b' + classname + '\\b'),
      els = node.getElementsByTagName("*");

  for(var i=0,j=els.length; i<j; i++) {
    if(re.test(els[i].className))a.push(els[i]);
  }

  return a;
}
